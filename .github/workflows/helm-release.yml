name: Helm Chart CI/CD

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
    paths:
      - 'Chart.yaml'
      - 'values.yaml'
      - 'templates/**'
  workflow_dispatch:

jobs:
  # 验证作业 - 对所有推送运行lint和template
  validate:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Helm
      uses: azure/setup-helm@v4
      with:
        version: '3.12.1'

    - name: Lint Helm Chart
      run: |
        helm lint .

    - name: Render Template
      run: |
        helm template . --debug

  # 发布作业 - 仅在标签推送时执行
  release:
    runs-on: ubuntu-latest
    # 仅在标签推送时运行此作业
    if: startsWith(github.ref, 'refs/tags/v')
    needs: validate
    permissions:
      contents: write  # 用于发布到GitHub Pages
      packages: write  # 用于发布到GHCR
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Helm
      uses: azure/setup-helm@v4
      with:
        version: '3.12.1'

    - name: Get Chart Info
      id: chart
      run: |
        CHART_NAME=$(yq '.name' Chart.yaml)
        CHART_VERSION=$(yq '.version' Chart.yaml)
        echo "name=$CHART_NAME" >> $GITHUB_OUTPUT
        echo "version=$CHART_VERSION" >> $GITHUB_OUTPUT
        
        # 打印调试信息
        echo "Chart名称: $CHART_NAME"
        echo "Chart版本: $CHART_VERSION"

    - name: Package Helm Chart
      run: |
        helm package .
        
        # 检查文件是否存在
        PACKAGE_NAME="${{ steps.chart.outputs.name }}-${{ steps.chart.outputs.version }}.tgz"
        if [ -f "$PACKAGE_NAME" ]; then
          echo "Helm包已成功创建: $PACKAGE_NAME"
          ls -la
        else
          echo "错误: Helm包创建失败!"
          exit 1
        fi

    # 1. 发布到GitHub Pages (兼容传统Helm仓库)
    - name: Setup Helm Repository
      run: |
        # 创建临时目录用于Helm仓库，包括docs子目录
        mkdir -p helm-repo/docs
        
        # 确保创建.nojekyll文件以完全禁用Jekyll
        touch helm-repo/.nojekyll
        
        # 复制打包好的chart到Helm仓库的docs目录
        cp ${{ steps.chart.outputs.name }}-${{ steps.chart.outputs.version }}.tgz helm-repo/docs/
        
        # 如果存在旧的index.yaml，下载它
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        if git ls-remote --heads origin gh-pages; then
          git clone --branch gh-pages --single-branch --depth 1 https://x-access-token:${{ github.token }}@github.com/${{ github.repository }} gh-pages-branch
          if [ -f gh-pages-branch/docs/index.yaml ]; then
            cp gh-pages-branch/docs/index.yaml helm-repo/docs/
          fi
        fi
        
        # 创建或更新index.yaml
        cd helm-repo/docs
        if [ ! -f index.yaml ]; then
          helm repo index . --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
        else
          helm repo index . --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }} --merge index.yaml
        fi
        
        # 显示仓库内容以便调试
        echo "Helm仓库内容:"
        ls -la

    # 使用简单的git命令直接提交到gh-pages分支
    - name: Deploy to GitHub Pages
      run: |
        cd helm-repo
        git init
        git add .
        git commit -m "更新Helm仓库 - ${{ steps.chart.outputs.name }}:${{ steps.chart.outputs.version }}"
        git push -f https://x-access-token:${{ github.token }}@github.com/${{ github.repository }} HEAD:gh-pages
        
    # 2. 发布到GHCR (OCI格式)
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Push Helm Chart to GHCR
      run: |
        echo "Publishing Helm chart ${{ steps.chart.outputs.name }}:${{ steps.chart.outputs.version }} to GHCR"
        
        # 检查文件是否存在
        PACKAGE_NAME="${{ steps.chart.outputs.name }}-${{ steps.chart.outputs.version }}.tgz"
        if [ ! -f "$PACKAGE_NAME" ]; then
          echo "错误: 找不到Helm包 $PACKAGE_NAME!"
          ls -la
          exit 1
        fi
        
        # 推送版本标签
        helm push "$PACKAGE_NAME" oci://ghcr.io/${{ github.repository_owner }}/helm-charts
        
        # 额外推送latest标签
        echo "Tagging and pushing as latest"
        LATEST_FILENAME="${{ steps.chart.outputs.name }}-latest.tgz"
        cp "$PACKAGE_NAME" "$LATEST_FILENAME"
        
        # 检查latest文件是否存在
        if [ ! -f "$LATEST_FILENAME" ]; then
          echo "错误: 创建latest标签文件失败!"
          ls -la
          exit 1
        fi
        
        helm push "$LATEST_FILENAME" oci://ghcr.io/${{ github.repository_owner }}/helm-charts

    - name: Output Repository Info
      run: |
        echo "Chart已发布到GHCR和GitHub Pages"
        echo ""
        echo "GHCR (OCI) 使用方法:"
        echo "1. 安装/获取特定版本:"
        echo "   helm install my-release oci://ghcr.io/${{ github.repository_owner }}/helm-charts/${{ steps.chart.outputs.name }} --version ${{ steps.chart.outputs.version }}"
        echo "   helm pull oci://ghcr.io/${{ github.repository_owner }}/helm-charts/${{ steps.chart.outputs.name }} --version ${{ steps.chart.outputs.version }}"
        echo ""
        echo "2. 使用latest标签:"
        echo "   helm install my-release oci://ghcr.io/${{ github.repository_owner }}/helm-charts/${{ steps.chart.outputs.name }} --version latest"
        echo "   helm pull oci://ghcr.io/${{ github.repository_owner }}/helm-charts/${{ steps.chart.outputs.name }} --version latest"
        echo ""
        echo "GitHub Pages (传统Helm仓库) 使用方法:"
        echo "1. 添加Helm仓库:"
        echo "   helm repo add ${{ steps.chart.outputs.name }} https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        echo "2. 安装chart:"
        echo "   helm install my-release ${{ steps.chart.outputs.name }}/${{ steps.chart.outputs.name }} --version ${{ steps.chart.outputs.version }}"